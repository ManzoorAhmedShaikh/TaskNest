{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>TaskNest | My Todos</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        crossorigin="anonymous">

  <!-- Font Awesome -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

  <style>
    body {
      background-color: #eee;
    }

    .gradient-custom-2 {
      background: linear-gradient(to right, #ee7724, #d8363a, #dd3675, #b44593);
    }

    .todo-card {
      border-radius: 1rem;
      background-color: #f8f9fa;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .form-control:focus {
      box-shadow: none;
      border-color: #ced4da;
    }

    .status-badge {
      background-color: #ffc107;
      color: #212529;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 0.5rem;
      padding: 0.3rem 0.6rem;
      user-select: none;
      cursor: pointer;
    }

    .todo-title {
      font-size: 1.1rem;
      font-weight: 500;
    }

    .todo-meta {
      font-size: 0.8rem;
      color: #6c757d;
    }

    .todo-actions i {
      font-size: 1rem;
    }

    .todo-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background-color: #fff;
      border-radius: 0.5rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .hidden {
      display: none !important;
    }

    .status-badge.completed {
      background-color: #28a745; /* Bootstrap green */
      color: white;
    }
    .status-badge.active {
      background-color: #ffc107; /* Yellow */
      color: #212529;
    }
    .save-button {
      margin-left: 10px;
      font-size: 0.8rem;
      padding: 0.3rem 0.6rem;
      border-radius: 0.3rem;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    .save-button:hover {
      background-color: #0056b3;
    }

    #todoList {
      max-height: 180px; /* or whatever fits your layout */
      overflow-y: auto;
      padding-right: 10px; /* optional: prevents scrollbar overlap */
    }

  </style>
</head>
<body>
<section class="vh-100 gradient-custom-2">
  <div class="container py-5 h-100">
    <div class="row justify-content-center align-items-center h-100">
      <div class="col-lg-10">
        <div class="card todo-card">
          <div class="card-body px-4 px-md-5 py-5">

            <!-- Header -->
            <div class="text-center mb-5">
              <div class="text-end mb-4">
              <form action="/" method="POST" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="action" value="logout">
                <button type="submit" class="btn btn-sm gradient-custom-2 text-white px-3 py-1" style="border-radius: 0.4rem;">
                  <i class="fas fa-sign-out-alt me-1"></i>Logout
                </button>
              </form>
              </div>
              <img src="{% static 'Logo.png' %}" style="width: 120px;" alt="logo">
              <h2 class="mt-3 text-dark">Welcome '{{user.username}}'<br>in your TaskNest Todo</h2>
              <p class="text-muted">Stay organized. Stay productive.</p>
            </div>

            <!-- Add New Todo -->
            <div class="card mb-4">
              <div class="card-body">
                <div class="d-flex flex-row align-items-center">
                    <input type="text" id="newTodoInput" class="form-control form-control-lg me-3" placeholder="Add new...">
                    <button type="button" class="btn btn-custom btn-lg gradient-custom-2 text-white" onclick="addTodo()">Add</button>
                </div>
              </div>
            </div>

            <!-- Filters -->
            <div class="d-flex justify-content-end align-items-center mb-4">
              <p class="small mb-0 me-2 text-muted">By Status</p>
              <select class="form-select form-select-sm w-auto me-3" id="statusFilter">
                <option value="All">All</option>
                <option value="Completed">Completed</option>
                <option value="Active">Active</option>
              </select>
              <p class="small mb-0 me-2 text-muted">By Date</p>
              <input type="date" class="form-control form-control-sm w-auto me-3" id="todoDateFilter" value="2025-09-01">
              <i class="fas fa-calendar-alt text-white"></i>
            </div>

            <!-- Todo Items -->
            <div id="todoList">
            {% for note in notes %}
              {% if note.note_status %}
              <div class="todo-item" data-id="{{ note.id }}" data-status="Active" data-date="{{ note.note_date|date:'Y-m-d' }}">
              {% else %}
              <div class="todo-item" data-id="{{ note.id }}" data-status="Completed" data-date="{{ note.note_date|date:'Y-m-d' }}">
              {% endif %}
                <div class="d-flex align-items-center flex-grow-1">
                  <span class="todo-title">{{note.note_name}}</span>
                </div>
                <div class="d-flex align-items-center">
                  {% if note.note_status %}
                  <span class="status-badge active me-3" onclick="toggleStatus(this)">Active</span>
                  {% else %}
                  <span class="status-badge completed me-3" onclick="toggleStatus(this)">Completed</span>
                  {% endif %}
                  <p class="todo-meta mb-0 me-3"><i class="fas fa-info-circle me-1"></i>{{ note.note_date|date:"jS M Y" }}</p>
                </div>
            </div>
            {% endfor %}
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Filtering Script -->
<script>
  const statusFilter = document.getElementById('statusFilter');
  const dateFilter = document.getElementById('todoDateFilter');
  const todoItems = document.querySelectorAll('.todo-item');

  function filterTodos() {
    const selectedStatus = statusFilter.value;
    const selectedDate = dateFilter.value;

    const todoItems = document.querySelectorAll('.todo-item'); // âœ… Now dynamic

    todoItems.forEach(item => {
      const itemStatus = item.getAttribute('data-status');
      const itemDate = item.getAttribute('data-date');

      const matchesStatus = selectedStatus === "All" || itemStatus === selectedStatus;
      const matchesDate = !selectedDate || itemDate >= selectedDate;

      if (matchesStatus && matchesDate) {
        item.classList.remove('hidden');
      } else {
        item.classList.add('hidden');
      }
    });
  }


  statusFilter.addEventListener('change', filterTodos);
  dateFilter.addEventListener('change', filterTodos);

  // Initial filter on page load
  window.addEventListener('DOMContentLoaded', filterTodos);

  function addTodo() {
    const input = document.getElementById('newTodoInput');
    const todoText = input.value.trim();

    if (!todoText) {
      alert("Please enter a todo before adding.");
      return;
    }

    const currentDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    const displayDate = new Date().toLocaleDateString('en-GB', {
      day: 'numeric', month: 'short', year: 'numeric'
    });

    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Send data to Django backend
    fetch('/home', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        note_name: todoText,
        note_status: true, // true for Active
        note_date: currentDate,
        action: 'add'
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error("Failed to save note");
      }
      return response.json(); // Assuming backend returns JSON
    })
    .then(data => {
      // Add to UI only if backend confirms success
      const todoList = document.getElementById('todoList');
      const newTodo = document.createElement('div');
      newTodo.className = 'todo-item';
      newTodo.setAttribute('data-status', 'Active');
      newTodo.setAttribute('data-date', currentDate);
      newTodo.setAttribute('data-id', data.id);

      newTodo.innerHTML = `
        <div class="d-flex align-items-center flex-grow-1">
          <span class="todo-title">${todoText}</span>
        </div>
        <div class="d-flex align-items-center">
          <span class="status-badge active me-3" onclick="toggleStatus(this)">Active</span>
          <p class="todo-meta mb-0 me-3"><i class="fas fa-info-circle me-1"></i>${displayDate}</p>
        </div>
      `;

      todoList.prepend(newTodo);
      input.value = "";
      filterTodos();
    })
    .catch(error => {
      console.error("Error:", error);
      alert("Something went wrong while saving the note.");
    });
  }

  function toggleStatus(badge) {
    const todoItem = badge.closest('.todo-item');
    const currentStatus = badge.textContent.trim();

    // Toggle status
    if (currentStatus === "Active") {
      badge.textContent = "Completed";
      badge.classList.remove("active");
      badge.classList.add("completed");
    } else {
      badge.textContent = "Active";
      badge.classList.remove("completed");
      badge.classList.add("active");
    }

    // Show Save button if not already present
    if (!todoItem.querySelector('.save-button')) {
      const saveBtn = document.createElement('button');
      saveBtn.className = 'save-button';
      saveBtn.textContent = 'Save';
      saveBtn.onclick = function () {
        // Update data-status
        const newStatus = badge.textContent.trim();
        const noteId = todoItem.getAttribute('data-id');

        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        fetch('/home', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
          body: JSON.stringify({
            id: noteId,
            status: newStatus,
            action: 'update'
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            todoItem.setAttribute('data-status', newStatus);
            saveBtn.remove();
            filterTodos();
          } else {
            alert('Failed to update status');
          }
        });
    };
    badge.after(saveBtn);
  }
}
</script>
</body>
</html>
